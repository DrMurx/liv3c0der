<!DOCTYPE html>
<html lang="en">
<head>
<title>moz-shadow liv3c0der</title>
<style type="text/css" media="screen">
    body {
        background: red;
    }
    #editor {
        font-size: 20px;
        position: absolute;
        top: 10%;
        right: 10%;
        bottom: 10%;
        left: 10%;
        opacity: 0.4;
        z-index: 10;
        -webkit-transition: opacity 0.5s ease;
    }
    #editor.active {
        opacity: 0.8;
    }
    #canvas {
        position: absolute;
        top: 0; left:0; right: 0; bottom: 0;
        width: 100%; height: 100%;
        background-color: #000;
        z-index: 0;
    }
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>
<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    $(function() {
        var deactivate = function(e) {
            $('#editor').removeClass('active');
        };
        var drawMethod = null;
        var oldDrawMethod = null;
        var patternMethod = null;
        var oldPatternMethod = null;
        var timeout = null;
        var activate = function(e) {
            console.log("keypressed")
            $('#editor').addClass('active');
            if(timeout) {
                clearTimeout(timeout);
            }
            timeout = setTimeout(deactivate, 4000);
            return true;
        };
        var reload = function() {
            var code = editor.getValue();
            try {
                eval(code);
                if (drawMethod) oldDrawMethod = drawMethod;
                if (draw) drawMethod = draw;
                if (patternMethod) oldPatternMethod = patternMethod;
                if (pattern) patternMethod = pattern;
            } catch(e) {
                console.log(e);
            }

        }
        var keydown = function(e) {
            if(e.metaKey && e.keyCode == 13) {
                reload();
            }
            activate(e);
        }
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");

        editor.getSession().setMode("ace/mode/javascript");
        editor.container.addEventListener("keydown", keydown, true)
        // $(window).keydown(activate);
        editor.on('focus', activate);
        $(window).bind('resize', function() {
            $('#canvas').width(window.innerWidth).height(window.innerHeight);
        })
        var c = $('#canvas')[0].getContext('2d');
        c.width = 1024;
        c.height = 768;
        console.log(c.width, c.height);
        var state = {
            init: function(name, value) {
                if (typeof(this[name]) == 'undefined') this[name] = value;
            }
        };
        var canvasRunLoop = function() {
            if(drawMethod) {
                try {
                    drawMethod(c, state);
                } catch(e) {
                    console.log(e.lineNumber);
                    if (oldDrawMethod) {
                        drawMethod = oldDrawMethod;
                        drawMethod(c, state);
                    }
                }
            }
            requestAnimationFrame(canvasRunLoop);
        }
        canvasRunLoop();
        var tempo = 120;

        var steps = 16;
        var timePerPattern = steps / 4 / (tempo/60);
        var timePerStep = timePerPattern / steps;
        var ac =  new webkitAudioContext();
        var masterGain = ac.createGainNode();
        masterGain.gain.value = 0.5;
        masterGain.connect(ac.destination);
        var outlet = masterGain;
        var nextPattern = 0;
        var audioRunLoop = function() {
            if (nextPattern == 0 || (nextPattern - ac.currentTime) < 0.8) {
                if (nextPattern == 0) nextPattern = ac.currentTime;
                if (patternMethod) {
                    var notes = [];
                    var i,l;
                    try {
                        notes = patternMethod(ac, outlet, state, {});
                    } catch(e) {
                        patternMethod = oldPatternMethod;
                        notes = patternMethod(ac, outlet, state, {});
                    }
                    for(i=0,l=notes.length;i<l;i++) {
                        if (notes[i])
                            try {
                                notes[i](i*timePerStep + nextPattern, timePerStep);
                            } catch(e) {
                                console.log(e);
                            }

                    }
                }
                nextPattern += timePerPattern;
            }
            setTimeout(audioRunLoop, (timePerPattern * 1000) - 1000);
        }
        audioRunLoop();


    });
</script>
</head>
<body>
<div id="editor">
// NAME: default

function draw(c, s) {
    s.init('x',0.0);
    s.init('d',1)
    s.init('c', 0);
    c.clearRect(0,0,c.width, c.height);

    var i;
    var midx = c.width/2;
    var midy = c.height/2;
    var size = 400;
    s.c = 0;
    for(i=0.0;i<10*Math.PI;i+= 0.1) {
        c.fillStyle = "rgba(255," + Math.floor(s.c) + "," + Math.floor(255 - s.c) + ",0.1)";
        var x = size * Math.sin((s.x * 32) + i) + midx;
        var y = size * Math.cos((s.x) + i) + midy;
        c.beginPath();
        c.arc(x,y,40,0,2*Math.PI);
        c.fill();
        s.c = (s.c + 2) % 256;
    }


    s.x += 0.05;

}
// context, outlet, state, data
// should return array of functions that accept a single argument: the time
function pattern(c, o, s, d) {
  s.init('loop',0);
  function note(freq) {
      return function(t, l) {
        var gain = c.createGainNode();
        gain.connect(o);
        gain.gain.value = 0.0;
        gain.gain.linearRampToValueAtTime(1.0,t+0.1);
        gain.gain.setValueAtTime(1.0,t+(0.6*l));
        gain.gain.linearRampToValueAtTime(0.0,t+(0.8*l));
        var osc=c.createOscillator(); osc.frequency.value = freq; osc.connect(gain); osc.noteOn(t); osc.noteOff(t+(l*0.8));
      }
  }

  var freq = 110 * Math.pow(2,s.loop);
  s.loop = (s.loop + 1) % 5

  return [
    note(freq * 2),
    null,null,null,
    function(t,l) { var osc=c.createOscillator(); osc.connect(o); osc.noteOn(t); osc.noteOff(t+(l*0.4));},
    null,null,null,
    function(t,l) { var osc=c.createOscillator(); osc.connect(o); osc.noteOn(t); osc.noteOff(t+(l*0.8));},
    null,note(freq),null,
    function(t,l) { var osc=c.createOscillator(); osc.frequency.value = 880; osc.connect(o); osc.noteOn(t); osc.noteOff(t+(l*0.4));},
    null,note(freq * 2),
  ]
}

</div>
<canvas width=1024 height=768 id="canvas"></canvas>
</body>
</html>